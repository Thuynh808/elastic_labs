---
- name: configure kibana
  hosts: localhost
  vars:
    elastic_password: "password"  # Define password here
    kibana:
      - path: /etc/kibana/kibana.yml
        regex: '^#server.host:'
        line: "server.host: {{ ansible_default_ipv4['address'] }}"
      - path: /etc/kibana/kibana.yml
        regex: '^#server.port:'
        line: "server.port: 5601"
    elastic:
      - path: /etc/elasticsearch/elasticsearch.yml
        regex: '^#network.host:'
        line: "network.host: {{ ansible_default_ipv4['address'] }}"
      - path: /etc/elasticsearch/elasticsearch.yml
        regex: '^#http.port:'
        line: "http.port: 9200"
  tasks:
  
  - name: edit config files
    lineinfile:
      path: "{{ item.path }}"
      regex: "{{ item.regex }}"
      line: "{{ item.line }}"
    loop: "{{ elastic + kibana }}"
  
  - name: create elastic token for kibana
    shell: '/usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token --scope kibana > enrollment_token'
  
  - name: Set password for elastic user
    shell: "/usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic --batch"
    register: password_result

  - name: password_result
    copy:
      content: "{{ password_result.stdout_lines[1] }}"
      dest: ./password_result
